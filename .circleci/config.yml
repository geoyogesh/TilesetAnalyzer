version: 2.1

orbs:
  python: circleci/python@3.3.0
  node: circleci/node@7.2.1

executors:
  python-node:
    docker:
      - image: cimg/python:3.11-node
    working_directory: ~/repo

jobs:
  code-quality:
    executor: python-node
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-quality-deps-{{ checksum "pyproject.toml" }}-{{ checksum "webapp/tileset-analyzer-app/package.json" }}
            - v1-quality-deps-

      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            make install

      - save_cache:
          paths:
            - ./venv
            - webapp/tileset-analyzer-app/node_modules
          key: v1-quality-deps-{{ checksum "pyproject.toml" }}-{{ checksum "webapp/tileset-analyzer-app/package.json" }}

      - run:
          name: Run code quality checks
          command: |
            . venv/bin/activate
            make verify

  build-and-test:
    executor: python-node
    steps:
      - checkout

      - restore_cache:
          keys:
            - v2-dependencies-{{ checksum "pyproject.toml" }}
            - v2-dependencies-

      - run:
          name: Install Python dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -e ".[build]"

      - save_cache:
          paths:
            - ./venv
          key: v2-dependencies-{{ checksum "pyproject.toml" }}

      - restore_cache:
          keys:
            - v1-npm-{{ checksum "webapp/tileset-analyzer-app/package-lock.json" }}
            - v1-npm-

      - run:
          name: Build frontend
          command: |
            cd webapp/tileset-analyzer-app
            npm install
            echo "üèóÔ∏è  Building React application..."
            npm run build_local || (echo "‚ùå React build failed" && exit 1)
            echo "‚úÖ React build completed successfully"
            cd ../..

      - save_cache:
          paths:
            - webapp/tileset-analyzer-app/node_modules
          key: v1-npm-{{ checksum "webapp/tileset-analyzer-app/package-lock.json" }}

      - run:
          name: Verify build artifacts
          command: |
            . venv/bin/activate
            echo "üîç Verifying Python package..."
            python -c "import tileset_analyzer; print(f'‚úÖ Package version: {tileset_analyzer.__version__}')"

            echo "üîç Verifying React build artifacts..."
            # React build outputs to tileset_analyzer/static/ui/ (custom BUILD_PATH)
            test -d tileset_analyzer/static/ui || (echo "‚ùå React build failed - no ui directory" && exit 1)
            test -f tileset_analyzer/static/ui/index.html || (echo "‚ùå React build failed - no index.html" && exit 1)
            test -f tileset_analyzer/static/ui/static/js/main.*.js || (echo "‚ùå React build failed - no JavaScript bundle" && exit 1)

            echo "‚úÖ All build artifacts verified successfully"

      - persist_to_workspace:
          root: ~/repo
          paths:
            - .

  semantic-release:
    executor: python-node
    steps:
      - attach_workspace:
          at: ~/repo

      - run:
          name: Configure Git
          command: |
            git config user.name "semantic-release"
            git config user.email "semantic-release@circleci.com"
            git remote set-url origin https://${GITHUB_TOKEN}@github.com/geoyogesh/TilesetAnalyzer.git

      - run:
          name: Install Python dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -e ".[build]"

      - run:
          name: Run semantic release
          command: |
            . venv/bin/activate
            semantic-release version
            semantic-release publish

      - run:
          name: Build Python package
          command: |
            . venv/bin/activate
            python -m build

      - persist_to_workspace:
          root: ~/repo
          paths:
            - dist

  publish-pypi:
    executor: python-node
    steps:
      - attach_workspace:
          at: ~/repo

      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -e ".[build]"

      - run:
          name: Upload to PyPI
          command: |
            . venv/bin/activate
            python -m twine upload dist/* --username __token__ --password $PYPI_API_TOKEN

workflows:
  # Main workflow - runs on ALL branches
  build-and-verify:
    jobs:
      # Step 1: Code quality checks (GATEKEEPER)
      # Fails if code doesn't meet quality standards
      - code-quality

      # Step 2: Build and test (requires quality to pass first)
      # Ensures code actually builds and works
      - build-and-test:
          requires:
            - code-quality

      # Step 3: Release (only on main branch)
      # Automated versioning and changelog
      - semantic-release:
          requires:
            - build-and-test
          filters:
            branches:
              only: main

      # Step 4: Publish to PyPI (only on main after release)
      - publish-pypi:
          requires:
            - semantic-release
          filters:
            branches:
              only: main
